<!DOCTYPE html>

<html>

<head>
  <title>Wash me, maybe?</title>

  <meta property="og:image"
    content="images/webapp/touch-icon-iphone-retina.png" />
  <meta property="og:title" content="Wash me, maybe?" />
  <meta property="og:description"
    content="The one-click app that lets you know when you should wash your car." />

  <meta name="viewport" id="vp"
    content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width" />
  <meta name="viewport" id="vp"
    content="initial-scale=1.0,user-scalable=no,maximum-scale=1"
    media="(device-height: 568px)" />

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Carwash?">

  <link rel="apple-touch-icon-precomposed"
    href="images/webapp/touch-icon-precomposed.png" />
  <link rel="apple-touch-icon-precomposed" sizes="57x57"
    href="images/webapp/touch-icon-57x57.png" />
  <link rel="apple-touch-icon-precomposed" sizes="72x72"
    href="images/webapp/touch-icon-ipad.png" />
  <link rel="apple-touch-icon-precomposed" sizes="114x114"
    href="images/webapp/touch-icon-iphone-retina.png" />
  <link rel="apple-touch-icon-precomposed" sizes="144x144"
    href="images/webapp/touch-icon-ipad-retina.png" />

  <link rel="apple-touch-startup-image"
    href="images/launch/apple-touch-startup-image-640x1096.png"
    media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)">
  <link rel="apple-touch-startup-image"
    href="images/launch/apple-touch-startup-image-320x460.png"
    media="(device-width: 320px) and (device-height: 480px) and (-webkit-device-pixel-ratio: 1)">
  <link rel="apple-touch-startup-image"
    href="images/launch/apple-touch-startup-image-640x920.png"
    media="(device-width: 320px) and (device-height: 480px) and (-webkit-device-pixel-ratio: 2)">

  <link type="text/css" rel="stylesheet" href="reset.css" />
  <link type="text/css" rel="styleshee"
    href="http://fonts.googleapis.com/css?family=Open+Sans:400,600">
  <link type="text/css" rel="stylesheet" href="global.css" />
</head>

<body>
  <header>
    <h1>Wash me, maybe?</h1>
  </header>

  <section id="main">
    <h2>Please enable location services.</h2>
    <h3 id="carwash"></h3>
    <span id="details">This app requires access to your current location in
      order to get the correct weather forecast.</span>
  </section>

  <section id="nearby">
    <h2 class="expand"><a href="#">Nearby carwashes</a></h2>
    <div class="expand-content">

    </div>
  </section>

  <section id="forecast">
    <h2 class="expand"><a href="#">Daily forecast breakdown</a></h2>
    <div class="expand-content">
      <table>
        <tr>
          <th>Date</td>
          <th>Conditions</td>
          <th>Rain</td>
        </tr>
      </table>
    </div>
  </section>

  <section id="moreinfo">
    <h2 class="expand"><a href="#">Statistics</a></h2>
    <div class="expand-content">
      <table>
        <tr>
          <td>Number of sunny days</td>
          <td id="totalsunny"></td>
        </tr>
        <tr>
          <td>Number of non-sunny days</td>
          <td id="totalnonsunny"></td>
        </tr>
        <tr>
          <td>Carwash effectiveness<br />(in days)</td>
          <td id="maximumeffectiveness"></td>
        </tr>
        <tr>
          <td>Best day for a wash</td>
          <td id="bestday"></td>
        </tr>
      </table>
    </div>
  </section>

  <section id="about">
    <h2 class="expand"><a href="#">About this app</a></h2>
    <div class="expand-content">
      <p>Definition of when to get a car wash: Five consecutive days with no
        precipitation.</p>
      <p>Copyright &copy; 2013.</p>
      <span><a
          href="http://www.wunderground.com/?apiref=0980c42f54080dd3">Powered by
          Weather Underground</a></span>
      <span><a href="http://www.robinguan.com">Created by Robin Guan</a></span>
    </div>
  </section>

  <script src="js/jQuery.js"></script>
  <script src="js/jStorage.js"></script>
  <script src="js/jQuery.cache.js"></script>
  <script src="js/geoPosition.js"></script>
  <script>
    function getWeather(urlString) {
      var maximumCarwashEffectiveness = 0;
      var carwashEffectiveness = 0;
      var totalSunnyDays = 0;
      var totalNonSunnyDays = 0;
      var bestDayCounter = null;
      var actualBestDay = null;
      var actualBestDayString = "";
      $.ajax({
        url: urlString,
        cacheJStorage: true,
        cacheKey: "weather",
        cacheTTL: 3600,
        isCacheValid: function () {
          return true;
        },
        dataType: "jsonp",
        success: function (json) {
          var days = json['forecast']['simpleforecast']['forecastday'];
          for (var i = 0; i < days.length; i++) {
            if (days[i]['qpf_allday']['mm'] == 0) {
              totalSunnyDays++;
              carwashEffectiveness++;
              if (bestDayCounter == null) {
                bestDayCounter = i;
              }
              if (carwashEffectiveness > maximumCarwashEffectiveness) {
                maximumCarwashEffectiveness = carwashEffectiveness;
                if (maximumCarwashEffectiveness > 4) {
                  actualBestDay = bestDayCounter;
                }
              }
            } else {
              totalNonSunnyDays++;
              if (carwashEffectiveness > maximumCarwashEffectiveness) {
                maximumCarwashEffectiveness = carwashEffectiveness;
                if (maximumCarwashEffectiveness > 4) {
                  actualBestDay = bestDayCounter;
                }
              }
              carwashEffectiveness = 0;
              bestDayCounter = null;
            }

            $("#totalsunny").html(totalSunnyDays);
            $("#totalnonsunny").html(totalNonSunnyDays);
            $("#maximumeffectiveness").html(maximumCarwashEffectiveness);

            if (actualBestDay != null) {
              if (actualBestDay == 0) {
                actualBestDayString = "Today";
              } else if (actualBestDay == 1) {
                actualBestDayString = "Tomorrow";
              } else {
                actualBestDayString = days[actualBestDay]['date']['monthname'] + " " + days[actualBestDay]['date']['day'];
              }
              $("#bestday").html(actualBestDayString);
            } else {
              actualBestDayString = "";
              $("#bestday").html("Not anytime soon.");
            }

            if (actualBestDay == 0) {
              $("#carwash").html("Yes");
              $("#main").attr("class", "yes");
              $("#details").html("Wash it today!");
            } else {
              if (actualBestDay != null) {
                $("#carwash").html("No");
                $("#main").attr("class", "no");
                $("#details").html("Wait until " + actualBestDayString + ".");
              } else {
                $("#carwash").html("No");
                $("#main").attr("class", "no");
                $("#details").html("Not anytime soon.");
              }
            }

            // generate data table
            var rain = days[i]['qpf_allday']['in'];
            var rainString = "";

            if (rain > 0) {
              rainString = rain + " in";
            } else {
              rainString = "None";
            }

            if (i == 0) {
              $("#forecast table").append("<tr><td>Today</td><td>" + days[i]['conditions'] + "</td><td>" + rainString + "</td></tr>");
            } else if (i == 1) {
              $("#forecast table").append("<tr><td>Tomorrow</td><td>" + days[i]['conditions'] + "</td><td>" + rainString + "</td></tr>");
            } else {
              $("#forecast table").append("<tr><td>" + days[i]['date']['monthname'] + " " + days[i]['date']['day'] + ", " + days[i]['date']['year'] + "</td><td>" + days[i]['conditions'] + "</td><td>" + rainString + "</td></tr>");
            }
            $("#forecast").show();
            $("#moreinfo").show();
          }
        }
      });
    }

    function getCarWash(urlString, locationString) {
      $.ajax({
        url: urlString,
        cacheJStorage: true,
        cacheKey: "carwash",
        cacheTTL: 60,
        isCacheValid: function () {
          return true;
        },
        dataType: "json",
        success: function (json) {
          var results = json['results'];
          for (var i = 0; i < 3; i++) {
            $("#nearby div").append("<span><a href=\"http://maps.google.com/maps?saddr=" + locationString + "&daddr=" + encodeURIComponent(results[i]['vicinity']) + "\">" + results[i]['name'] + "</a></span>");
          }
          $("#nearby").show();
        }
      });
    }

    $(function () {
      var locationString = "";

      if (geoPosition.init()) {
        // supports geolocation
        geoPosition.getCurrentPosition(function (p) {
          $("#main h2").html("Should I wash my car today?");
          $("#details").html("");
          locationString = p.coords.latitude + "," + p.coords.longitude;
          var urlString = "http://api.wunderground.com/api/6f8c314e000f4ccf/forecast10day/q/" + locationString + ".json";
          $("#location").html(locationString);
          getWeather(urlString);
          var urlStringForCarwash = "googleProxy.php?location=" + locationString;
          getCarWash(urlStringForCarwash, locationString);
        }, function () {
          $("#main h2").html("Should I wash my car today?");
          $("#details").html("");
          locationString = "";
          var urlString = "http://api.wunderground.com/api/6f8c314e000f4ccf/forecast10day/q/autoip.json";
          $("#location").html("Unknown");
          getWeather(urlString);
        });
      } else {
        // no support for geolocation
        $("#main h2").html("Your device does not support location services.");
      }

      $("#nearby h2 a").click(function (e) {
        e.preventDefault();
        $("#nearby div").slideToggle("fast", function () {
          $("body").animate({
            scrollTop: $(this).offset().top
          }, "fast")
        });
      });

      $("#forecast h2 a").click(function (e) {
        e.preventDefault();
        $("#forecast div").slideToggle("fast", function () {
          $("body").animate({
            scrollTop: $(this).offset().top
          }, "fast")
        });
      });

      $("#moreinfo h2 a").click(function (e) {
        e.preventDefault();
        $("#moreinfo div").slideToggle("fast", function () {
          $("body").animate({
            scrollTop: $(this).offset().top
          }, "fast")
        });
      });

      $("#about h2 a").click(function (e) {
        e.preventDefault();
        $("#about div").slideToggle("fast", function () {
          $("body").animate({
            scrollTop: $(this).offset().top
          }, "fast")
        });
      });
    });

    var addToHomeConfig = {
      touchIcon: true,
      startDelay: 0
    };
  </script>
  <link rel="stylesheet" href="add2home.css">
  <script src="js/add2home.js"></script>
  <script>
    (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date(); a = s.createElement(o),
      m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-40304565-1', 'washmemaybe.com');
    ga('send', 'pageview');
  </script>
</body>

</html>